#!/bin/bash

# Usage: ./git-auto-commit.sh /path/to/parent-dir

TARGET_DIR=${1:-$(pwd)}  # default to current dir if no argument passed

if [ ! -d "$TARGET_DIR" ]; then
  echo "âŒ Error: $TARGET_DIR is not a valid directory."
  exit 1
fi

echo "ðŸ” Searching for Git repos under: $TARGET_DIR"
echo

# Loop through all subdirectories that are Git repos
find "$TARGET_DIR" -type d -name ".git" | while read gitdir; do
  clear

  REPO_DIR=$(dirname "$gitdir")
  echo "ðŸ“ Checking repo: $REPO_DIR"

  cd "$REPO_DIR" || continue
  make clean 2>/dev/null


  if [[ -n $(git status --porcelain) ]]; then
    echo "âš ï¸  Uncommitted changes detected in $REPO_DIR"
    echo -e "$(git -c color.status=always status -s)\n"

    echo -n "ðŸ‘‰ Add these changes? (y/n): " > /dev/tty
    read -r ADD_CONFIRM < /dev/tty
    if [[ "$ADD_CONFIRM" =~ ^[Yy]$ ]]; then
      git add .
    fi

    echo -n "ðŸ“ Commit the changes? (y/n): " > /dev/tty
    read -r COMMIT_CONFIRM < /dev/tty
    if [[ "$COMMIT_CONFIRM" =~ ^[Yy]$ ]]; then
      echo -n "ðŸ’¬ Enter commit message: " > /dev/tty
      read -r COMMIT_MSG < /dev/tty
      git commit -m "$COMMIT_MSG"
    fi

    echo -n "ðŸš€ Push the changes? (y/n): " > /dev/tty
    read -r PUSH_CONFIRM < /dev/tty
    if [[ "$PUSH_CONFIRM" =~ ^[Yy]$ ]]; then
      git push origin main
    fi

  else
    echo "âœ… No uncommitted changes in $REPO_DIR"
  fi

  echo
done

echo "âœ… Done."

